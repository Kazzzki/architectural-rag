# RAG現状レポート 2026-02-24

## サマリー
- **総ドキュメント数（SQLite）**: 381件（completed: 36件 / unprocessed: 345件）
- **総チャンク数（ChromaDB）**: **4,181チャンク**
- **問題チャンク数**: ~2,270件（重複インデックス + 一時PDF混入 + source_pdf欠損）

| 指標 | 数値 | 評価 |
|---|---|---|
| ChromaDB総チャンク | 4,181 | |
| source_pdf欠損チャンク | 1,878 (44.9%) | ⚠️ 重大 |
| category空チャンク | 31 (0.7%) | △ |
| tags_str空チャンク | 466 (11.1%) | △ |
| 一時チャンクPDF混入 | 396チャンク (9.5%) | ⚠️ 重大 |
| 法規ファイルトリプルインデックス | ~797チャンク重複 | ⚠️ 重大 |
| knowledge_base内同名重複ファイル | 201グループ | ⚠️ 重大 |

---

## 詳細

### 1. ディレクトリ構造

**knowledge_base** (`/Users/kkk/Google Drive/My Drive/建築意匠ナレッジDB`)

| ディレクトリ | ファイル数 |
|---|---|
| `02_図面/` | 33 |
| `03_技術基準/` | 74 |
| `10_参照PDF/` | 152 |
| `20_検索MD/` | 56 |
| `3_法規チェック/` | 12 |
| `90_処理用データ/` | 6 |
| `99_システム/` | 6 |
| `uploads/` | 66 |
| (root) | 21 |
| **合計** | **426** |

> ⚠️ 旧体系（`10_参照PDF/`, `20_検索MD/`）と新体系（`3_法規チェック/` 等のカテゴリ直下）が混在。  
> これが ChromaDB のトリプルインデックスの根本原因。

**data/pdfs/** (`architectural_rag/data/pdfs/`)
- ファイル数: **4件**（.pdfのみ）、合計 **3.4 MB**
- MD5重複: **なし** ✅

**data/input/** — 未処理ファイル **6件** 残存

---

### 2. ChromaDB コレクション状況

- コレクション名: `architectural_knowledge`
- 総チャンク数: **4,181**

**メタデータキー一覧**
```
category, chunk_index, file_type, filename, modified_at,
page_number, rel_path, source_pdf, sub_subcategory, subcategory, tags_str
```
> `page_number` — 全チャンク存在（欠損率 0%） ✅

**rel_path 拡張子分布**

| 拡張子 | チャンク数 | 備考 |
|---|---|---|
| `.md` | 3,785 (90.5%) | 正常 |
| `.pdf` | 396 (9.5%) | ⚠️ 一時チャンクPDFが混入 |

→ `.pdf` 396件は全て OCR処理中の一時ファイル（`.chunk_N_ファイル名.pdf`）が直接インデックスされたもの。`source_pdf` は全件 null。

**category 分布（チャンク数）**

| category | チャンク数 |
|---|---|
| `3_法規チェック/3-3_消防法` | 1,608 |
| `03_技術基準` | 1,152 |
| `3_法規チェック/3-1_建築基準法（単体規定）` | 642 |
| `02_図面` | 307 |
| `10_参照PDF` | 212 |
| `uploads` | 149 |
| `04_リサーチ成果物` | 34 |
| (empty) | 31 |
| その他 | 46 |

---

### 3. 重複チェック

**3a. data/pdfs/ MD5重複** → 重複なし（4ファイル全てユニーク） ✅

**3b. knowledge_base/ 同名ファイル重複** → **201グループ重複あり**

代表例:
```
[e-Gov_.md]
  20_検索MD/3-3_消防法/e-Gov_.md
  3_法規チェック/3-3_消防法/e-Gov_.md   ← 旧+新体系に同一ファイル

[.chunk_0_ナレッジベース①：意匠編.pdf]
  (root)/.chunk_0_ナレッジベース①...pdf
  90_処理用データ/chunks/.chunk_0_ナレッジベース①...pdf  ← 一時ファイル重複
```

**ChromaDBトリプルインデックス（同一ファイルが3パスで登録）**

| ファイル | パス数 | チャンク数×3 |
|---|---|---|
| `e-Gov__1771747688_10.md` | 3 | 266 × 3 = **798** |
| `e-Gov_.md` | 3 | 245 × 3 = **735** |
| `e-Gov__1771747688_8.md` | 3 | 214 × 3 = **642** |

→ 法規ファイル数本が3倍チャンクとして登録 → **RAG回答が法規コンテンツに著しく偏る**

---

### 4. メタデータ品質チェック

| フィールド | 欠損数 | 欠損率 |
|---|---|---|
| `source_pdf` | 1,878 | **44.9%** |
| `page_number` | 0 | 0% ✅ |
| `category` | 31 | 0.7% |
| `tags_str` | 466 | 11.1% |

**source_pdf 欠損の内訳**

| file_type / category | チャンク数 |
|---|---|
| `md / 03_技術基準` | 577 |
| `md / 3_法規チェック/3-3_消防法` | 536 |
| `md / 3_法規チェック/3-1_建築基準法` | 214 |
| `pdf / 10_参照PDF` | 212（一時PDF混入） |
| `md / 02_図面` | 119 |
| `pdf / uploads` | 106（一時PDF混入） |
| `pdf / 02_図面` | 69（一時PDF混入） |
| その他 | 45 |

---

### 5. SQLite の状態

- DB: `data/antigravity.db` / テーブル: `documents`（1テーブルのみ）
- 総レコード数: **381件**

**processing_status 集計**

| status | 件数 |
|---|---|
| `unprocessed` | 345 |
| `completed` | 36 |

> ℹ️ `unprocessed` のうち `last_indexed_at` がnon-nullは345件 → OCR未実行だがインデックス済みという状態で、statusが実態と乖離している。

**file_type**

| file_type | 件数 |
|---|---|
| `pdf` | 254 |
| `md` | 127 |

**インデックス更新日範囲**: 2026-02-16 ～ 2026-02-24

**category 分布（SQLite）**

| category | 件数 |
|---|---|
| `10_参照PDF` | 120 |
| `uploads` | 69 |
| `20_検索MD` | 56 |
| (empty) | 50 |
| `03_技術基準` | 39 |
| `02_図面` | 32 |

---

## 発見した問題点リスト（優先度付き）

### 🔴 緊急・高優先度

| # | 問題 | 影響 | 対策案 |
|---|---|---|---|
| **P1** | 法規MDが旧・新体系の3パスで ChromaDB にトリプル登録 | RAG回答が法規コンテンツに極度偏向（法規系が全チャンクの57%） | 旧ディレクトリ（`20_検索MD/`, `3-3_消防法/`等の孤立コピー）を削除し ChromaDB を再構築 |
| **P2** | 一時チャンクPDF（`.chunk_N_...`）396件がインデックス混入 | ノイズが全チャンクの9.5%。検索品質低下 + source_pdf欠損396件の原因 | `EXCLUDE_FOLDERS` に `90_処理用データ` を追加し再インデックス。ルートの `.chunk_*` を削除 |
| **P3** | `source_pdf` 欠損44.9%（1,878チャンク）→ PDF参照リンク切れ | チャットのソースをクリックしてもPDFが開けない | P1+P2解消で大幅削減可能。残りのMD系はFrontmatterに `source_pdf` を付与 |

### 🟡 中優先度

| # | 問題 | 影響 | 対策案 |
|---|---|---|---|
| **P4** | knowledge_base内201グループの同名重複ファイル | ディレクトリ移行中で旧/新体系が混在。誤参照リスク | 旧体系（`10_参照PDF/`, `20_検索MD/`）から新体系への正式マイグレーション完了 |
| **P5** | SQLite `status=completed` が36件のみ（実態と乖離） | OCRステータス管理が機能していない | インデックス済みファイルを `completed` に一括更新するバッチ処理 |
| **P6** | `category` 空チャンク 31件 | カテゴリフィルタ検索が機能しない | Frontmatterに `primary_category` 付与後、部分再インデックス |
| **P7** | `tags_str` 空チャンク 466件（11.1%） | タグフィルタが機能しない | 分類ルール（classify_rules.yaml）見直し、自動タグ付け強化 |

### 🟢 低優先度

| # | 問題 | 影響 | 対策案 |
|---|---|---|---|
| **P8** | `data/input/` に6件の未処理ファイル残存 | インデックス漏れ | OCRパイプラインに投入 |
| **P9** | `data/pdfs/` のPDFが4件のみ（新ハッシュ管理未普及） | ハッシュベースPDF参照が機能しきっていない | 既存254件PDFをハッシュリネームして `data/pdfs/` に段階的に移行 |
