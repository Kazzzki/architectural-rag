# RAG現状レポート 2026-02-27

## サマリー
- **総ドキュメント数（SQLite）**: 381件（completed: 36件 / unprocessed: 345件）
- **総チャンク数（ChromaDB）**: **4,181チャンク**
- **最新の更新 (2026-02-27)**:
    - データベース保存先を `data/` に統一し、既存データの自動移行機能を実装。
    - Google Drive連携設定のパスを `data/secrets/` に集約。
    - フロントエンドのマインドマップ表示におけるロードエラー処理の改善。
    - 実装内容をGitHubリポジトリ（mainブランチ）へ同期。

| 指標 | 数値 | 評価 |
|---|---|---|
| ChromaDB総チャンク | 4,181 | |
| source_pdf欠損チャンク | 1,878 (44.9%) | ⚠️ 重大 |
| category空チャンク | 31 (0.7%) | △ |
| tags_str空チャンク | 466 (11.1%) | △ |
| 一時チャンクPDF混入 | 396チャンク (9.5%) | ⚠️ 重大 |
| 法規ファイルトリプルインデックス | ~797チャンク重複 | ⚠️ 重大 |
| knowledge_base内同名重複ファイル | 201グループ | ⚠️ 重大 |

---

## 詳細

### 1. 更新履歴（2026-02-27）

- **インフラ整備**: SQLiteデータベースと認証情報の保存先を `data/` ディレクトリ配下に整理。コードベース内での相対パス指定を強化し、環境構築の再現性を向上。
- **データ移行**: 旧パス（root直下）のDBファイルを検知した場合、新構成へ自動移行するロジックを `database.py` に追加。
- **フロントエンド**: Next.js 側のエラーハンドリング（Project一覧取得失敗時）を修正。
- **リポジトリ管理**: 上記すべての修正を GitHub に push 完了。

---

### 2. ディレクトリ構造

**knowledge_base** (`/Users/kkk/Google Drive/My Drive/建築意匠ナレッジDB`)

| ディレクトリ | ファイル数 |
|---|---|
| `02_図面/` | 33 |
| `03_技術基準/` | 74 |
| `10_参照PDF/` | 152 |
| `20_検索MD/` | 56 |
| `3_法規チェック/` | 12 |
| `90_処理用データ/` | 6 |
| `99_システム/` | 6 |
| `uploads/` | 66 |
| (root) | 21 |
| **合計** | **426** |

> ⚠️ 旧体系（`10_参照PDF/`, `20_検索MD/`）と新体系（`3_法規チェック/` 等のカテゴリ直下）が混在。  
> これが ChromaDB のトリプルインデックスの根本原因。

**data/pdfs/** (`architectural_rag/data/pdfs/`)
- ファイル数: **4件**（.pdfのみ）、合計 **3.4 MB**
- MD5重複: **なし** ✅

**data/input/** — 未処理ファイル **6件** 残存

---

### 3. ChromaDB コレクション状況（前回から変更なし）

- コレクション名: `architectural_knowledge`
- 総チャンク数: **4,181**

**メタデータキー一覧**
```
category, chunk_index, file_type, filename, modified_at,
page_number, rel_path, source_pdf, sub_subcategory, subcategory, tags_str
```
> `page_number` — 全チャンク存在（欠損率 0%） ✅

---

### 4. SQLite の状態

- DB: `data/antigravity.db`（root直下から移行）
- 総レコード数: **381件**

---

## 発見した問題点リスト（優先度付き）

### 🔴 緊急・高優先度

| # | 問題 | 影響 | 対策案 |
|---|---|---|---|
| **P1** | Google Drive 同期エラー | ローカル構成の変更により同期が停止。 | `DriveFS` キャッシュのクリアと再設定が必要。 |
| **P2** | 法規MDが3パスで重複登録 | RAG回答の実効性低下。 | 旧ディレクトリ削除とChromaDB再構築。 |
| **P3** | 一時チャンクPDFの混入 | 検索ノイズが増大。 | 除外設定の反映。 |

### 🟡 中優先度

| # | 問題 | 影響 | 対策案 |
|---|---|---|---|
| **P4** | `source_pdf` 欠損 | PDF参照リンク切れ。 | P1~P3解消後にメタデータ補完。 |
| **P5** | 既存DB・セッションの不整合 | 移行時のパス不一致。 | 実施済（2026-02-27 対応完了）。 |
